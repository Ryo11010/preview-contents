# Plan — Edit 20251205_142847__app-debt-burndown

## 背景 / 目的
- `app.tsx` の UI モックアップに残る技術負債（重複ロジック・ガード不足・ハンドラ乱立など）を整理し、Canvas プレビューを含む既存 UI/挙動を変えずに安定性と保守性を高める。
- 単一ファイル要件を維持しつつ、責務分離と定数化・型安全性の徹底で今後の変更コストを下げる。

## 参照 (Fail-Avoid / Success-Reuse)
- Failure 事例: /artifacts に未登録のため該当なし。
- Success 事例:
  - 20251204_230100__app-native-ready: プラットフォーム依存処理をブリッジ化し、ブラウザ API 呼び出しをガード付きヘルパーに集約 → 同様に外部呼び出しを一箇所にまとめる。
  - 20251204_214311__app-hardening: セクション別コンポーネント化と定数集約で UI/プレビューを崩さずに整理 → 今回もデータ/スタイルトークンを集中管理する方針を踏襲。
  - 20251204_211221__folder-interaction: レイアウト・モーション値を定数化し、型付きデータドリブンに → フォルダ/カード周辺の動作を同じパターンで保守しやすくする。
  - 20251204_150627__ui-refactor: 連絡先/リンク/コピーをコンテンツ定数に集約し新規環境依存値を追加しない → 文言・URL を既存定数経由に統一する。
- Workset ガードレール: 各会話=1修正、3+1必須、単一ファイル維持、ハードコード絶対禁止、500行ルール（単一ファイル要件下での最小化を目指し理由を明記）。

## agents.md 重要ポイント（抜粋）
- ハードコード絶対禁止: 環境依存の URL/ID/閾値/文言をロジックへ直書きしない。設定・定数・文言セクションへ集約する。
- A/B/C 方式で代替案を提示し、採用案を明示する。
- 3+1（before/after/diff/meta）＋ `file-map.md` 更新を必須とする。
- 命名規則: 英語・役割明確、真偽値は is*/has*/can*、マジックナンバー排除。500 行超は理由を記す。
- デバッグ出力: コンソール禁止、必要なら既定オーバーレイだが今回は追加しない。

## 代替案 (A/B/C)
- (A) 単一ファイル内で **責務境界を明確化**: 型の厳格化（カテゴリ Union 化）、UI 定数/コピー/メトリクスの整理、共通ハンドラの一元化（外部リンク/共有/メール/スクロール/レスポンシブ判定）、データドリブン描画の簡素化。Pros: 負債を削りつつ UI/プレビュー不変。Cons: 変更範囲中。影響: 低〜中。コスト: 中。
- (B) 軽微リネーム中心: 型やハンドラ構造は維持しつつコメント整理と小修正に留める。Pros: リスク最小。Cons: 負債多く残存、再発しやすい。影響: 低。コスト: 低。
- (C) 抜本再実装: コンポーネント/ファイル分割やデザイン変更を伴う。Pros: 根本解決。Cons: 単一ファイル・UI不変要件に抵触、工数/リスク大。影響: 高。コスト: 高。

### 採用案
- **(A) を採用。** 単一ファイル・UI/プレビュー不変のまま、型/定数/ハンドラの整理とガード強化で安定性と保守性を最大化できるため。

## 影響範囲
- UI/挙動/Canvas プレビュー: 変更しない（フォルダ展開、ドック移動、シート、タイムライン、シェア/メール操作は既存通り）。
- 構造: 型の Union 化、共通ハンドラ・レスポンシブ判定の一元化、定数/コピー整理、コンポーネント内ロジックのガード強化。
- パフォーマンス: 無駄なイベントリスナーや再生成を削減し微改善を狙うが体感は不変。

## テスト計画
- 手動: セクションスクロール→ドック遷移、フォルダ展開→カード選択→シート開閉、タイムライン経由でのカード遷移、シェア/メール起動、Canvas プレビュー表示を確認。
- 自動: 環境が整えば lint/型チェックを実行（不可の場合は理由を meta/evaluation に記録）。

## ハードコードに関する計画
- 既存のコピー/URL/テクスチャ/メトリクスは先頭の定数セクションで集中管理し、ロジック内に新規リテラルを追加しない。
- レスポンシブ判定やしきい値、外部呼び出しは UI_METRICS/定数経由に統一し、ガード付きヘルパーのみから呼ぶ。
- 新規の環境依存値を追加しない。例外が必要になった場合はコメントと TODO で設定置換を明記する。

## ロールバック方針
- `before/after` のスナップショットを保存し、問題発生時は `app.tsx` を before 版に戻す。
- 変更が定数/ハンドラ整理中心のため、該当セクション単位で戻すことで復旧可能。

## 相談・承認
- status: yes
- approver: user
- time: 2025-12-05T14:30:00Z
- memo: ユーザーより「yes」を受領したため実装を開始する。
